---
title: "Maps of smarter farming articles country origin"
author: "Mia Thuge Kuntz"
date: "12-May-2023 updated `r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```



MAYBE ALREADY DESCRIBE THE MAPS HERE

```{r remove, include=FALSE}
rm(list=ls())
```

## Preparing data
In order to visualise the data in a meaningful way I first need to prepare it. First step is reading in the necessary libraries and then read in the data and inspect it.

```{r libraries}
library(leaflet)
library(readxl)
library(sf)
library(RColorBrewer)
library(dplyr)
library(htmltools)
library(tidyverse)
library(ggplot2)
library(ggnewscale)
```

```{r read data}
# reading file containing articles' information including country
articles <- read_excel("data/articles.xlsx")
articles

# reading GeoJSON file containing country boundaries
countries <- st_read("data/countries.geojson")
countries
```

The `articles` data is read in as a data frame, and at first inspection seems to have everything it should have included. The `countries` file is read in as a simple feature object with 255 features and 2 fields. Its a multipolygon, which means that the countries geometry is a collection of multiple polygons. The dimension of the data is a two dimensional coordinate system "XY", where the bounding box values show that it covers nearly the whole world. 
The coordinate reference system (CRS) of the data is WGS84, which is typical when working with global spatial data.  

Next part of the code focuses on preparing the data to be visualised. I first split those rows in the "Country" column which has several countries in it so to be able to credit all countries responsible for that particular article when they are visualised in the maps. I thereafter unnest those arrays into their own set of rows. Lastly, I merge the two data set into one `merged_data` data frame by the two columns where they share content.     

```{r prep data}
# splitting multiple countries in "Country" column into separate rows
articles$Country <- strsplit(articles$Country, ", ")

# unnesting to convert array into set of rows 
articles <- unnest(articles, Country)

# merging articles and countries based on country column
merged_data <- merge(articles, countries, by.x = "Country", by.y = "ADMIN", all.x = TRUE)
merged_data
```

When inspecting the `merged_data` data frame is appears as if all the columns from the two data files have merged successfully. This data frame only contains the countries and ISO codes of the countries which appears in the `articles` file.

To get a quick impression of the distribution of articles across countries I wish to add a count bar for the top five countries appearing in the `articles` data. To do this I first create a separate table for the `Country` column in the `merged_data` data frame. I then convert this to a data frame of its own, so that I am able to use these counts for later use in the maps. Lastly, I arrange the `counts_df` in descending order according to the `Count` column and then assign the top five countries to its own object. 

```{r frequency count}
# calculating frequency count of each country
country_counts <- table(merged_data$Country)

# converting frequency counts to data frame
counts_df <- data.frame(Country = names(country_counts), Count = as.numeric(country_counts))
counts_df

# merging country counts with countries GeoJSON data
merged_geojson <- merge(countries, counts_df, by.x = "ADMIN", by.y = "Country", all.x = TRUE)
merged_geojson

# getting top five countries with highest number of studies
top_countries <- counts_df %>%
  arrange(desc(Count)) %>%
  head(5)

# Convert the 'Country' column to factor with ordered levels based on 'Count'
top_countries$Country <- factor(top_countries$Country, levels = top_countries$Country[order(top_countries$Count)])

# Plotting bar chart of top five countries count
ggplot(top_countries, aes(x = Country, y = Count)) +
  geom_bar(stat = "identity", fill = "darkgreen") +
  labs(title = "Top Five Countries Count", x = "Country", y = "Count") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = seq(0, max(top_countries$Count), by = 2), labels = function(x) as.character(as.integer(x)))
```

```{r word cloud}
library(wordcloud)
library(extrafont)

# Set seed for reproducibility
set.seed(123)

# Create a character vector of keywords
keywords <- articles$Keywords

# Concatenate all the keywords into a single string
keywords_string <- paste(keywords, collapse = ";")

# Split the keywords string at semicolons
keywords_split <- strsplit(keywords_string, ";", fixed = TRUE)[[1]]

# Remove any leading/trailing whitespaces and convert to lowercase
keywords_split <- tolower(trimws(keywords_split))

# Generate word frequencies
keyword_freq <- table(keywords_split)

# Remove common words
stopwords <- c("the", "and", "of", "in", "to", "for")
keyword_freq <- keyword_freq[!(names(keyword_freq) %in% stopwords)]

# Define color palette
color_palette <- brewer.pal(length(keyword_freq), "Greens")[-(1:3)]  # Exclude first four colors

# Create a word cloud with colors and nicer shape
wordcloud(names(keyword_freq), freq = keyword_freq,
          random.order = FALSE, colors = color_palette,
          scale = c(5, 1.2), rot.per = 0.3,
          family = "serif", font = 3)
```



## Choropleth map


```{r choropleth prep}
# create leaflet map
choropleth_map <- leaflet(data = merged_geojson) %>%
  setView(lng = 0, lat = 0, zoom = 2) %>%
  addProviderTiles("OpenStreetMap.Mapnik") %>%
  addPolygons(fillColor = ~colorNumeric(color_palette, domain = Count)(Count),
              weight = 1,
              opacity = 1,
              color = "white",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight = 2,
                color = "white",
                fillOpacity = 0.9
              ),
              label = ~paste(ADMIN, ": ", Count)) %>%
  addLegend("bottomright", pal = colorNumeric(color_palette, domain = unique(counts_df$Count)), values = unique(counts_df$Count), title = "Count") %>%
  addControl(html = as.character(tags$div(HTML(paste0("<h4>Top 5 Countries</h4>",
                                                      "<table>",                                                      "<thead><tr><th>Country</th><th>Count</th></tr></thead>",
                                                      "<tbody>",
                                                      paste0("<tr><td>", top_countries$Country, "</td><td>", top_countries$Count, "</td></tr>", collapse = "\n"),
                                                      "</tbody>",
                                                      "</table>")))),
              position = "bottomleft") %>%
  addControl(html = as.character(tags$div(id = "map-title", style = "background-color: white; padding: 10px; font-family: Arial, sans-serif; font-size: 16px; font-weight: bold;", "World map of studies in Smart Farming")),
              position = "topright")
```

```{r choropleth map}
# displaying choropleth map
choropleth_map
```

## Centroid map

```{r prep centroid}
# Repair invalid geometries
merged_geojson <- st_make_valid(merged_geojson)

# Simplify country geometries
simplified_geojson <- st_simplify(merged_geojson, preserveTopology = TRUE, dTolerance = 0.01)

# Create centroids for each country
centroids <- st_centroid(simplified_geojson)

# Extract coordinates from centroids
centroids <- st_coordinates(centroids)

# Convert to data frame
centroids_df <- as.data.frame(centroids)

# Rename the columns
colnames(centroids_df) <- c("x", "y")

# Combine with the count data
centroids_df <- cbind(centroids_df, Count = simplified_geojson$Count)
```

```{r centroid prep}
# Create the centroid map
centroid_map <- ggplot() +
  geom_sf(data = countries, fill = "grey", alpha = 0.3) +
  new_scale("size") +
  geom_point(data = centroids_df, aes(x = x, y = y, size = Count, color = Count), alpha = 0.7) +
  scale_size(range = c(1, 10), name = "Count") +
  scale_color_gradient(low = "blue", high = "red", name = "Count") +
  theme_void() +
  coord_sf() +
  labs(title = "World Map of Studies in Smart Farming") +
  theme(plot.title = element_text(hjust = 0.5, size = 16)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  guides(size = FALSE)
```

```{r centroid map}
centroid_map
```

